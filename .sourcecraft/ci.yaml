on:
  pull_request:
    - workflows: [deploy-all-services, deploy-rag-service]
      filter:
        source_branches: [""]
        target_branches: ["master"]

    - workflows: [deploy-rag-service]
      filter:
        source_branches: [""]
        target_branches: ["master"]
        paths: ["yandex-camp-bot/rag-service/**"]

  push:
    - workflows: [deploy-all-services, deploy-rag-service]
      filter:
        branches: ["master"]

    - workflows: [deploy-rag-service]
      filter:
        branches: ["master"]
        paths: ["yandex-camp-bot/rag-service/**"]

workflows:
  deploy-all-services:
    tasks:
      - setup-ssh
      - deploy-regular-services

  deploy-rag-service:
    tasks:
      - setup-ssh
      - deploy-rag-only

tasks:
  - name: setup-ssh
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
    cubes:
      - name: configure-ssh
        script: 
          - |
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            # Добавляем перевод строки в конце ключа если его нет
            echo "" >> ~/.ssh/id_rsa
            ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
            # Проверяем что ключ валидный
            ssh-keygen -l -f ~/.ssh/id_rsa
            echo "SSH setup completed"

  - name: deploy-regular-services
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      REGISTRY_ID: ${{ secrets.REGISTRY_ID }}
      SERVICE_ACCOUNT_ID: ${{ secrets.SERVICE_ACCOUNT_ID }}
    cubes:
      - name: build-push-deploy-regular
        script: 
          - |
            services=("api-gateway" "monitoring-service" "dialogue-service" "security-service")
            
            for service in "${services[@]}"; do
              echo "Deploying $service..."
              # Используем ssh-agent для управления ключом
              eval $(ssh-agent -s)
              ssh-add ~/.ssh/id_rsa
              
              ssh -o StrictHostKeyChecking=no -o BatchMode=yes -v $SSH_USER@$SSH_HOST "
                cd /home/yandexcamp/yandex-camp-bot/yandex-camp-bot && \
                docker build -t cr.yandex/$REGISTRY_ID/$service:latest -f $service/Dockerfile . && \
                docker push cr.yandex/$REGISTRY_ID/$service:latest && \
                yc serverless container revision deploy \
                  --container-name $service \
                  --image cr.yandex/$REGISTRY_ID/$service:latest \
                  --service-account-id $SERVICE_ACCOUNT_ID
              "
              echo "Finished deploying $service"
            done
            
            echo "Regular services deployed successfully!"

  - name: deploy-rag-only
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      REGISTRY_ID: ${{ secrets.REGISTRY_ID }}
      SERVICE_ACCOUNT_ID: ${{ secrets.SERVICE_ACCOUNT_ID }}
    cubes:
      - name: build-push-deploy-rag
        script: 
          - |
            echo "Deploying rag-service..."
            # Используем ssh-agent для управления ключом
            eval $(ssh-agent -s)
            ssh-add ~/.ssh/id_rsa
            
            ssh -o StrictHostKeyChecking=no -o BatchMode=yes -v $SSH_USER@$SSH_HOST "
              cd /home/yandexcamp/yandex-camp-bot/yandex-camp-bot && \
              docker build -t cr.yandex/$REGISTRY_ID/rag-service:latest -f rag-service/Dockerfile . && \
              docker push cr.yandex/$REGISTRY_ID/rag-service:latest && \
              yc serverless container revision deploy \
                --container-name rag-service \
                --image cr.yandex/$REGISTRY_ID/rag-service:latest \
                --service-account-id $SERVICE_ACCOUNT_ID
            "
            echo "Finished deploying rag-service"