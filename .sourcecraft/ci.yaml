on:
  pull_request:
    - workflows: [deploy-all-services]
      filter:
        source_branches: [""]
        target_branches: ["master"]

    - workflows: [deploy-rag-service]
      filter:
        source_branches: [""]
        target_branches: ["master"]
        paths: ["yandex-camp-bot/rag-service/**"]

  push:
    - workflows: [deploy-all-services]
      filter:
        branches: ["master"]

    - workflows: [deploy-rag-service]
      filter:
        branches: ["master"]
        paths: ["yandex-camp-bot/rag-service/**"]

workflows:
  deploy-all-services:
    tasks:
      - deploy-regular-services

  deploy-rag-service:
    tasks:
      - deploy-rag-only

tasks:
  - name: deploy-regular-services
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      REGISTRY_ID: ${{ secrets.REGISTRY_ID }}
      SERVICE_ACCOUNT_ID: ${{ secrets.SERVICE_ACCOUNT_ID }}
    cubes:
      - name: build-push-deploy-regular
        script: 
          - |
            # Настраиваем SSH в той же задаче
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            echo "" >> ~/.ssh/id_rsa
            ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
            
            services=("api-gateway" "monitoring-service" "dialogue-service" "security-service")
            
            for service in "${services[@]}"; do
              echo "Deploying $service..."
              ssh -o StrictHostKeyChecking=no -o BatchMode=yes -i ~/.ssh/id_rsa $SSH_USER@$SSH_HOST "
                # Добавляем пути к yc и docker-credential-yc
                export PATH=\$PATH:/home/yandexcamp/yandex-cloud/bin
                cd /home/yandexcamp/yandex-camp-bot/yandex-camp-bot && \
                docker build -t cr.yandex/$REGISTRY_ID/$service:latest -f $service/Dockerfile . && \
                docker push cr.yandex/$REGISTRY_ID/$service:latest && \
                /home/yandexcamp/yandex-cloud/bin/yc serverless container revision deploy \
                  --container-name $service \
                  --image cr.yandex/$REGISTRY_ID/$service:latest \
                  --service-account-id $SERVICE_ACCOUNT_ID
              "
              echo "Finished deploying $service"
            done
            
            echo "Regular services deployed successfully!"

  - name: deploy-rag-only
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      REGISTRY_ID: ${{ secrets.REGISTRY_ID }}
      SERVICE_ACCOUNT_ID: ${{ secrets.SERVICE_ACCOUNT_ID }}
    cubes:
      - name: build-push-deploy-rag
        script: 
          - |
            # Настраиваем SSH в той же задаче
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            echo "" >> ~/.ssh/id_rsa
            ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
            
            echo "Deploying rag-service..."
            ssh -o StrictHostKeyChecking=no -o BatchMode=yes -i ~/.ssh/id_rsa $SSH_USER@$SSH_HOST "
              # Добавляем пути к yc и docker-credential-yc
              export PATH=\$PATH:/home/yandexcamp/yandex-cloud/bin
              cd /home/yandexcamp/yandex-camp-bot/yandex-camp-bot && \
              docker build -t cr.yandex/$REGISTRY_ID/rag-service:latest -f rag-service/Dockerfile . && \
              docker push cr.yandex/$REGISTRY_ID/rag-service:latest && \
              /home/yandexcamp/yandex-cloud/bin/yc serverless container revision deploy \
                --container-name rag-service \
                --image cr.yandex/$REGISTRY_ID/rag-service:latest \
                --service-account-id $SERVICE_ACCOUNT_ID
            "
            echo "Finished deploying rag-service"