# Monitoring Service

Сервис централизованного логирования и мониторинга микросервисов с поддержкой трассировки и классификации ошибок.

## Функциональность

- **Централизованное логирование**: Сбор логов от всех сервисов
- **Метрики производительности**: Отслеживание ключевых показателей
- **Анализ данных**: Статистика и отчеты
- **Трассировка запросов**: Отслеживание пути запроса через все сервисы
- **Классификация ошибок**: Автоматическое разделение security alerts и технических ошибок
- **Детальный анализ**: Полная информация о трейсах и ошибках

## API Endpoints

### Логи
- `POST /logs` - Создание записи лога
- `POST /logs/bulk` - Массовое создание логов
- `GET /logs` - Получение логов с фильтрацией

### Метрики
- `POST /metrics` - Создание метрики
- `GET /stats` - Системная статистика

### Трассировка
- `POST /traces` - Создание записи трейса
- `GET /traces` - Получение трейсов с фильтрацией
- `GET /trace/{trace_id}` - Получение всех спанов трейса
- `GET /trace/{trace_id}/full` - Полный трейс с деталями ошибок
- `GET /request/{request_id}/full` - Полный трейс по request_id

### Ошибки
- `POST /errors` - Создание записи ошибки
- `GET /errors` - Получение ошибок с фильтрацией (с поддержкой category)

### Метрики и статистика
- `GET /metrics/traces/count` - Количество трейсов по времени
- `GET /metrics/errors/count` - Количество ошибок по времени
- `GET /metrics/performance` - Метрики производительности
- `GET /metrics/services/summary` - Сводка по сервисам

## База данных

Использует PostgreSQL для хранения логов и метрик.

### Структура таблиц

- **logs**: Логи от всех сервисов
- **metrics**: Метрики производительности
- **service_health**: Статус здоровья сервисов
- **traces**: Трейсы запросов через сервисы
- **errors**: Детальная информация об ошибках (с категориями security/technical)

## Миграция базы данных

При обновлении сервиса выполните миграцию для добавления новых полей:

```bash
cd monitoring-service
python migrate_db.py
```

Миграция добавит поле `category` в таблицу `errors` и автоматически классифицирует существующие ошибки.

## Dashboard

Веб-интерфейс для мониторинга доступен через Streamlit:

```bash
cd monitoring-service
streamlit run app/dashboard.py
```

### Возможности Dashboard

- **Общая статистика системы**: Количество логов, активных сервисов, уровень ошибок
- **Мониторинг здоровья сервисов**: Статус всех микросервисов
- **Графики производительности**: Время ответа, распределение запросов
- **Анализ ошибок**: Разделение security alerts и технических ошибок
- **Детальный просмотр**: Полная информация о трейсах и ошибках
- **Timeline визуализация**: Временная шкала выполнения запросов

## Конфигурация

```bash
DATABASE_URL=postgresql://user:password@db:5432/monitoring
MONITORING_SERVICE_URL=http://localhost:8004
```

## Запуск

```bash
cd monitoring-service
pip install -r requirements.txt

# Запуск API сервиса
uvicorn app.main:app --host 0.0.0.0 --port 8004

# В другом терминале - запуск Dashboard
streamlit run app/dashboard.py
```

## Очистка данных

Сервис поддерживает автоматическую очистку старых логов:

```bash
DELETE /logs/cleanup?days=30
```
